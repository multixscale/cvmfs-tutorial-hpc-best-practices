
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../proxy/">
      
      
        <link rel="next" href="../alternatives/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>Private Stratum 1 replica server - Best Practices for CernVM-FS in HPC</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fad675c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#private-stratum-1-replica-server" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Best Practices for CernVM-FS in HPC" class="md-header__button md-logo" aria-label="Best Practices for CernVM-FS in HPC" data-md-component="logo">
      
  <img src="../../img/logos/cvmfs_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Best Practices for CernVM-FS in HPC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Private Stratum 1 replica server
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/multixscale/cvmfs-tutorial-hpc-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Best Practices for CernVM-FS in HPC
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Best Practices for CernVM-FS in HPC" class="md-nav__button md-logo" aria-label="Best Practices for CernVM-FS in HPC" data-md-component="logo">
      
  <img src="../../img/logos/cvmfs_logo.png" alt="logo">

    </a>
    Best Practices for CernVM-FS in HPC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/multixscale/cvmfs-tutorial-hpc-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Best Practices for CernVM-FS in HPC
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Introduction to CernVM-FS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction to CernVM-FS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cvmfs/what-is-cvmfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What is CernVM-FS?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cvmfs/technical-details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical details
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cvmfs/flagship-repositories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flagship repositories
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    EESSI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            EESSI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/what-is-eessi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What is EESSI?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/motivation-goals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Motivation & goals
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/inspiration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inspiration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/high-level-design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    High-level design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/using-eessi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using EESSI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eessi/support/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting support
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Accessing repositories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Accessing repositories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CernVM-FS client system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Squid proxy server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Private Stratum 1 replica server
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Private Stratum 1 replica server
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cernvm-fs-as-cdn" class="md-nav__link">
    <span class="md-ellipsis">
      CernVM-FS as CDN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      Recommendations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      Setup procedure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup procedure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-cernvm-fs-server" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CernVM-FS server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-repository-public-key" class="md-nav__link">
    <span class="md-ellipsis">
      Adding repository public key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-repository-replica" class="md-nav__link">
    <span class="md-ellipsis">
      Creating repository replica
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating repository replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronisation-server" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronisation server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-the-geoapi" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling the GeoAPI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-replica" class="md-nav__link">
    <span class="md-ellipsis">
      Creating replica
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initial-synchronisation" class="md-nav__link">
    <span class="md-ellipsis">
      Initial synchronisation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#periodic-synchronisation" class="md-nav__link">
    <span class="md-ellipsis">
      Periodic synchronisation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Periodic synchronisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      Log rotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cron-job" class="md-nav__link">
    <span class="md-ellipsis">
      Cron job
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-information" class="md-nav__link">
    <span class="md-ellipsis">
      More information
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Using the private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using the private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Only private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Only private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Client configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Proxy + private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proxy + private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reconfigure-squid-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Reconfigure Squid proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      Client configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusions" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../alternatives/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Alternative access methods
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration_hpc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration on HPC systems
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../performance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Performance aspects
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Containers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../creating-repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a CernVM-FS repository
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/terminology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix: Terminology
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cernvm-fs-as-cdn" class="md-nav__link">
    <span class="md-ellipsis">
      CernVM-FS as CDN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      Recommendations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      Setup procedure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup procedure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-cernvm-fs-server" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CernVM-FS server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-repository-public-key" class="md-nav__link">
    <span class="md-ellipsis">
      Adding repository public key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-repository-replica" class="md-nav__link">
    <span class="md-ellipsis">
      Creating repository replica
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating repository replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronisation-server" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronisation server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-the-geoapi" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling the GeoAPI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-replica" class="md-nav__link">
    <span class="md-ellipsis">
      Creating replica
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initial-synchronisation" class="md-nav__link">
    <span class="md-ellipsis">
      Initial synchronisation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#periodic-synchronisation" class="md-nav__link">
    <span class="md-ellipsis">
      Periodic synchronisation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Periodic synchronisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      Log rotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cron-job" class="md-nav__link">
    <span class="md-ellipsis">
      Cron job
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-information" class="md-nav__link">
    <span class="md-ellipsis">
      More information
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Using the private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using the private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Only private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Only private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Client configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy-private-stratum-1" class="md-nav__link">
    <span class="md-ellipsis">
      Proxy + private Stratum 1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proxy + private Stratum 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reconfigure-squid-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Reconfigure Squid proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      Client configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusions" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="private-stratum-1-replica-server">Private Stratum 1 replica server<a class="headerlink" href="#private-stratum-1-replica-server" title="Permanent link">&para;</a></h1>
<p>In this section of the tutorial, we will set up a <a href="../../appendix/terminology/#stratum1">Stratum 1 replica server</a>, which is the next step towards
a production-ready CernVM-FS setup.</p>
<h2 id="cernvm-fs-as-cdn">CernVM-FS as CDN<a class="headerlink" href="#cernvm-fs-as-cdn" title="Permanent link">&para;</a></h2>
<p>The content of CernVM-FS repositories is served by a set of
Stratum 1 replica servers (sometimes also called <em>mirror servers</em>),
which together with the central <a href="../../appendix/terminology/#stratum0">Stratum 0 server</a>
and the <a href="../../appendix/terminology/#proxy">proxy servers</a> can be seen as
a <a href="https://en.wikipedia.org/wiki/Content_delivery_network">content delivery network (CDN)</a>.</p>
<p>A Stratum 1 replica server is a <strong>standard web server</strong> that uses the CernVM-FS server
tools to provide a full mirror of one or more CernVM-FS repositories,
which are served and managed through a central Stratum 0 server.</p>
<p>The figure below shows the CernVM-FS network for repositories in the <code>cern.ch</code> domain,
including the Stratum 1 replica servers which are spread all across the world,
and a distributed hierarchy of proxy servers which fetch content from the closest Stratum 1.</p>
<p align="center">
<img src="../../img/cvmfs-stratum1.png" alt="CernVM-FS content distribution network for the cern.ch domain" width="80%"/></br>
</p>

<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Next to the <em>public</em> Stratum 1 servers that are operated by the maintainers
of a CernVM-FS repository, you can also set up your own "private" Stratum 1
replica server in your local network.</p>
<p>In the context of using CernVM-FS on HPC infrastructure this brings the following benefits:</p>
<ul>
<li>To improve the overall reliability of the setup, for example in case of (temporary) loss of connectivity to the public Stratum 1 replica servers;</li>
<li>To reduce the load on the public Stratum 1 servers;</li>
<li>To mitigate the impact of poor network bandwidth to the closest public Stratum 1 server;</li>
<li>To improve the latency and hence start-up time of software in situations where the cache of the proxy servers has insufficient capacity;</li>
</ul>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<p>When setting up a Stratum 1 replica server, you should take the following
recommendations into account:</p>
<ul>
<li>A RAID-protected <strong>low latency storage</strong> setup (like <a href="https://en.wikipedia.org/wiki/Solid-state_drive">SSD</a>
  or <a href="https://en.wikipedia.org/wiki/NVM_Express">NVMe</a>) should be used,
  because the CernVM-FS server component will run lots of <code>stat</code> system calls against it.</li>
<li>An <a href="https://en.wikipedia.org/wiki/Ext3"><code>ext3</code></a> or <a href="https://en.wikipedia.org/wiki/Ext4"><code>ext4</code></a> file system
  is preferred (rather than <a href="https://en.wikipedia.org/wiki/XFS">XFS</a>).</li>
<li>A standard Apache web server should be installed, which should be close to the
  low latency storage. Directory listing is not required.</li>
<li>HTTP connections to port <code>80</code> must be possible.</li>
</ul>
<details class="note">
<summary>Recommendations on monitoring <em>(click to expand)</em></summary>
<p>It is strongly recommended to actively monitor a Stratum 1 replica server,
in particular:</p>
<ul>
<li>CPU usage;</li>
<li>disk usage;</li>
<li>I/O load;</li>
<li>network bandwidth and latency;</li>
<li>log messages produced in <a href="https://en.wikipedia.org/wiki/Syslog">syslog</a>;</li>
</ul>
<p>The <a href="https://github.com/cvmfs-contrib/cvmfs-servermon"><code>cvmfs-servermon</code></a> package can be used to watch for problems
in every repositoryâ€™s <code>.cvmfs_status.json</code> status file.</p>
<p><a href="https://cvmfs.readthedocs.io/en/stable/cpt-replica.html#monitoring">See also the CernVM-FS documentation</a>.</p>
</details>
<details class="note">
<summary>Recommendations for a high-availability setup <em>(click to expand)</em></summary>
<p>To create a high-availability setup, it is <em>not</em> recommended to use two or more
separate Stratum 1 replica servers in a single round-robin service.</p>
<p>Since they will be updated at different rates, that would cause errors when a client
sees an updated <a href="../../appendix/terminology/#catalog">catalog</a> from one Stratum 1, but then tries to read corresponding data files from another that does not yet have the files.</p>
<p>Instead, different Stratum 1 replica servers
should either be separately configured on the clients, or a pair can be configured 
as a high availability active/standby pair using the
<a href="https://github.com/cvmfs-contrib/cvmfs-hastratum1"><code>cvmfs-hastratum1</code></a> package. </p>
<p>An active/standby pair can also be managed by switching a DNS name between two different servers.</p>
</details>
<details class="note">
<summary>Recommendations for a public Stratum 1 replica server <em>(click to expand)</em></summary>
<p>For a public Stratum 1 replica server, it is recommended to install a <a href="http://www.squid-cache.org/">Squid frontend</a>
in front of the Stratum 1, which should be configured as a
<a href="https://en.wikipedia.org/wiki/Reverse_proxy"><em>reverse proxy</em></a>, and installed
on the same system as the web server, to reduce the number of points of failure.
The optimized <a href="https://osg-htc.org/docs/data/frontier-squid/"><code>frontier-squid</code></a>
distribution is recommended.
For more information, <a href="https://cvmfs.readthedocs.io/en/stable/cpt-replica.html#squid-configuration">see the CernVM-FS
configuration</a>.</p>
<p>Alternatively, separate Squid proxy server machines can be configured in a round-robin DNS configuration
and each forward to the Apache server.
Note however that if any of them are down the entire service will be considered down by CernVM-FS clients.
The impact of this can be mitigated through front end hardware load balancer that quickly takes a system that is down out of service.</p>
</details>
<details class="note">
<summary>Recommendations on garbage collection <em>(click to expand)</em></summary>
<p>If any CernVM-FS repositories being replicated have
<a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">garbage collection</a> enabled,
the Stratum 1 also needs to run garbage collection in order to prevent the disk space usage from growing rapidly.</p>
<p><a href="https://cvmfs.readthedocs.io/en/stable/cpt-replica.html#maintenance-processes">See the CernVM-FS
documentation</a> for more details.</p>
</details>
<details class="note">
<summary>Using S3-compatible storage (Amazon S3, Azure Blob, Ceph)</summary>
<p>CernVM-FS can store data directly to S3-compatible storage systems, such as <a href="https://aws.amazon.com/s3">Amazon S3</a>,
<a href="https://learn.microsoft.com/en-us/azure/storage/blobs">Azure Blob</a>, or <a href="https://ceph.io">Ceph</a>.</p>
<p>For more information, <a href="https://cvmfs.readthedocs.io/en/stable/cpt-repo.html#sct-s3storagesetup">see the CernVM-FS documentation</a>.</p>
</details>
<h2 id="setup-procedure">Setup procedure<a class="headerlink" href="#setup-procedure" title="Permanent link">&para;</a></h2>
<p>To set up a Stratum 1 replica server and configure it to replicate
a particular CernVM-FS repository, you should:</p>
<ul>
<li>Install the <code>cvmfs-server</code> package;</li>
<li>Add the public key of the CernVM-FS repository you want to replicate to <code>/etc/cvmfs/keys/</code>;</li>
<li>Create the repository replica;</li>
<li>Run the initial synchronisation;</li>
<li>Configure <code>cron</code> to perform periodic synchronisation;</li>
</ul>
<p>In the sections below, we will set up a Stratum 1 replica server for the <a href="../../eessi/high-level-design/#filesystem_layer">EESSI CernVM-FS repository <code>software.eessi.io</code></a>.</p>
<h3 id="installing-cernvm-fs-server">Installing CernVM-FS server<a class="headerlink" href="#installing-cernvm-fs-server" title="Permanent link">&para;</a></h3>
<p>Start with installing the <code>cvmfs-server</code> package which provides the CernVM-FS server tools.</p>
<p>Although we won't actually use the functionality that requires it,
we also need to install a package that provides the <code>mod_wsgi</code> Apache adapter module.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">For RHEL-based Linux distros (incl. CentOS, Rocky, Fedora, ...)</label><label for="__tabbed_1_2">For Debian-based Linux distros (incl. Ubuntu)</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="copy highlight"><pre><span></span><code><span class="c1"># install cvmfs-release package to add yum repository</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm

<span class="c1"># install CernVM-FS server package</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>cvmfs-server

<span class="c1"># install mod_wsgi Apache adapter module</span>
<span class="c1"># (on versions older than equivalent to RHEL8, install mod_wsgi instead)</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3-mod_wsgi
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="copy highlight"><pre><span></span><code><span class="c1"># install cvmfs-release package to add apt repository</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>lsb-release
curl<span class="w"> </span>-OL<span class="w"> </span>https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest_all.deb
sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cvmfs-release-latest_all.deb
sudo<span class="w"> </span>apt<span class="w"> </span>update

<span class="c1"># install CernVM-FS server package + the required mod-wsgi</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>cvmfs-server

<span class="c1"># install mod_wsgi Apache adapter module</span>
<span class="c1"># (on Ubuntu versions older than 22.04, install libapache2-mod-wsgi instead)</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>libapache2-mod-wsgi-py3
</code></pre></div>
</div>
</div>
</div>
<h3 id="adding-repository-public-key">Adding repository public key<a class="headerlink" href="#adding-repository-public-key" title="Permanent link">&para;</a></h3>
<p>Add the public key for the repositories in the <code>eessi.io</code> domain to <code>/etc/cvmfs/keys</code>:</p>
<div class="copy highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/cvmfs/keys/eessi.io/
sudo<span class="w"> </span>cp<span class="w"> </span>eessi.io.pub<span class="w"> </span>/etc/cvmfs/keys/eessi.io/
</code></pre></div>
<p>You can get the contents for <code>eessi.io.pub</code> from the default CernVM-FS config repository on a CernVM-FS client system
at:</p>
<div class="copy highlight"><pre><span></span><code>/cvmfs/cvmfs-config.cern.ch/etc/cvmfs/keys/eessi.io/eessi.io.pub
</code></pre></div>
<h3 id="creating-repository-replica">Creating repository replica<a class="headerlink" href="#creating-repository-replica" title="Permanent link">&para;</a></h3>
<p>To create the repository replica, we need to use run the <code>cvmfs_server add-replica</code> command.</p>
<h4 id="synchronisation-server">Synchronisation server<a class="headerlink" href="#synchronisation-server" title="Permanent link">&para;</a></h4>
<p>We will need to specify the server that should be used for synchronising
the repository contents.
This can either be the <a href="../../appendix/terminology/#stratum0">Stratum 0 server</a>, or a public Stratum 1 replica server
that was set up to be used for repository synchronisation
(by having a <code>.cvmfs_master_replica</code> file in the HTTP root directory).</p>
<p>For EESSI we should use <code>aws-eu-west-s1-sync.eessi.science</code> as synchronisation server.</p>
<h4 id="disabling-the-geoapi">Disabling the GeoAPI<a class="headerlink" href="#disabling-the-geoapi" title="Permanent link">&para;</a></h4>
<p>Before creating the replica, we first need to <em>disable</em> the
<a href="https://cvmfs.readthedocs.io/en/stable/cpt-replica.html#geo-api-setup">Geo API service</a>
in the CernVM-FS server configuration, to avoid getting this error when creating the replica:</p>
<div class="highlight"><pre><span></span><code>Installing GeoIP Database... CVMFS_GEO_LICENSE_KEY not set
fail
</code></pre></div>
<p>The Geo API service enables client systems to automatically sort Stratum 1 replica servers geographically,
so the CernVM-FS client component can prioritize connecting to the closest one.</p>
<p>This is really only relevant for <em>public</em> Stratum 1 replica servers, not a private Stratum 1 replica server
that is only accessible from within the local network, like the one we are setting up here.</p>
<p>To disable the Geo API service, set <code>CVMFS_GEO_DB_FILE</code> to <code>NONE</code> in <code>/etc/cvmfs/server.local</code>:</p>
<div class="copy highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;CVMFS_GEO_DB_FILE=NONE&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/cvmfs/server.local
</code></pre></div>
<h4 id="creating-replica">Creating replica<a class="headerlink" href="#creating-replica" title="Permanent link">&para;</a></h4>
<p>To actually create the replica, run the <code>cvmfs_server add-replica</code> command as follows,
specifying that the current user account should be the repository owner via <code>-o $USER</code>:</p>
<div class="copy highlight"><pre><span></span><code><span class="nv">sync_server</span><span class="o">=</span><span class="s1">&#39;aws-eu-west-s1-sync.eessi.science&#39;</span>
<span class="nv">repo</span><span class="o">=</span><span class="s1">&#39;software.eessi.io&#39;</span>
<span class="nv">key_dir</span><span class="o">=</span><span class="s1">&#39;/etc/cvmfs/keys/eessi.io&#39;</span>
sudo<span class="w"> </span>cvmfs_server<span class="w"> </span>add-replica<span class="w"> </span>-o<span class="w"> </span><span class="nv">$USER</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">sync_server</span><span class="si">}</span>/cvmfs/<span class="si">${</span><span class="nv">repo</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">key_dir</span><span class="si">}</span>
</code></pre></div>
<details class="note">
<summary>Starting Apache <em>(click to expand)</em></summary>
<p>If creating the replica fails with:</p>
<div class="highlight"><pre><span></span><code>Apache must be installed and running
</code></pre></div>
<p>try starting the <code>httpd</code> service first:</p>
<div class="copy highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>httpd.service
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>httpd.service
</code></pre></div>
</details>
<h3 id="initial-synchronisation">Initial synchronisation<a class="headerlink" href="#initial-synchronisation" title="Permanent link">&para;</a></h3>
<p>After creating the replica, we should trigger the initial synchronisation of the repository replica,
using the <code>cvmfs_server snapshot</code> command:</p>
<div class="copy highlight"><pre><span></span><code>cvmfs_server<span class="w"> </span>snapshot<span class="w"> </span>software.eessi.io
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Time for a coffee...</p>
<p>Since this will download the <em>full</em> repository contents from the synchronisation
server that was specified when creating the repository replica, the initial synchronisation may take a while.</p>
<p>The time required for the initial synchronisation is heavily dependent on the size of the repository,
and the available network latency to the synchronisation server.</p>
</div>
<h3 id="periodic-synchronisation">Periodic synchronisation<a class="headerlink" href="#periodic-synchronisation" title="Permanent link">&para;</a></h3>
<p>To ensure that updates to the contents of the CernVM-FS repository are synchronised
automatically to the Stratum-1 replica server, we should set up a cron job to do periodic synchronisation by running <code>cvmfs_server snapshot -a</code>.</p>
<h4 id="log-rotation">Log rotation<a class="headerlink" href="#log-rotation" title="Permanent link">&para;</a></h4>
<p>Before setting up a cron job, we first need to configure log rotation, or running <code>snapshot -a</code> will fail with:
<div class="highlight"><pre><span></span><code>/etc/logrotate.d/cvmfs does not exist!
</code></pre></div></p>
<p>Create <code>/etc/logrotate.d/cvmfs</code> with the following contents:</p>
<div class="copy highlight"><pre><span></span><code>/var/log/cvmfs/*.log<span class="w"> </span><span class="o">{</span>
<span class="w">    </span>weekly
<span class="w">    </span>missingok
<span class="w">    </span>notifempty
<span class="o">}</span>
</code></pre></div>
<h4 id="cron-job">Cron job<a class="headerlink" href="#cron-job" title="Permanent link">&para;</a></h4>
<p>To synchronize all active replica repositories every 5 minutes, we can create a cron job <code>/etc/cron.d/cvmfs_stratum1_snapshot</code> that runs <code>cvmfs_server snapshot -a -i</code>:</p>
<div class="copy highlight"><pre><span></span><code>*/5<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>OWNER<span class="w"> </span><span class="nv">output</span><span class="o">=</span><span class="k">$(</span>/usr/bin/cvmfs_server<span class="w"> </span>snapshot<span class="w"> </span>-a<span class="w"> </span>-i<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="k">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output</span><span class="s2">&quot;</span>
</code></pre></div>
<p>In here, you must replace "<code>OWNER</code>" with the account name of the repository owner (cfr. the <code>-o $USER</code> option
used in the <code>add-replica</code> command above).</p>
<p>The <code>-a</code> option enables synchronisation of <em>all active</em> replica repositories,
while <code>-i</code> indicates that that repositories for which an initial snapshot has not been run should be skipped.</p>
<p>To verify that periodic synchronisation is working correctly,
check the contents of the log file:</p>
<div class="copy highlight"><pre><span></span><code>/var/log/cvmfs/snapshots.log
</code></pre></div>
<h3 id="more-information">More information<a class="headerlink" href="#more-information" title="Permanent link">&para;</a></h3>
<p>For more information on the setup and configuration of a Stratum 1 replica server,
see the CernVM-FS documentation, in particular the following sections:</p>
<ul>
<li><a href="https://cvmfs.readthedocs.io/en/stable/cpt-repo.html#sct-serveranatomy">Notable CernVM-FS Server Locations and Files</a></li>
<li><a href="https://cvmfs.readthedocs.io/en/stable/apx-serverinfra.html">CernVM-FS Server Infrastructure</a></li>
</ul>
<h2 id="using-the-private-stratum-1">Using the private Stratum 1<a class="headerlink" href="#using-the-private-stratum-1" title="Permanent link">&para;</a></h2>
<p>To actually use the "private" Stratum 1 replica server that has been set up
we need to change the configuration on each CernVM-FS client system.</p>
<p>Initially, we will use <em>only</em> the private Stratum 1 replica server,
without a proxy server.</p>
<div class="admonition warning">
<p class="admonition-title">Remove <code>CVMFS_HTTP_PROXY</code> from client configuration</p>
<p>Do make sure that the <strong><code>CVMFS_HTTP_PROXY</code> line is removed</strong> from the CernVM-FS configuration file
<code>/etc/cvmfs/default.local</code> on the client system, and that the CernVM-FS configuration
was reloaded (with <code>sudo cvmfs_config reload</code>), as was instructed <a href="../proxy/#cleanup_proxy">here</a>.</p>
</div>
<p>After we have verified that the Stratum 1 is used by the client system,
we will bring the proxy server back in the game,
and demonstrate how to use both the proxy server and the Stratum 1 replica server.</p>
<h3 id="only-private-stratum-1">Only private Stratum 1<a class="headerlink" href="#only-private-stratum-1" title="Permanent link">&para;</a></h3>
<h4 id="client-configuration">Client configuration<a class="headerlink" href="#client-configuration" title="Permanent link">&para;</a></h4>
<p>The <code>CVMFS_SERVER_URL</code> configuration setting on a client system:</p>
<ul>
<li>Is a string value with a semicolon-separated (<code>;</code>) list of known Stratum 1 servers;</li>
<li>Should be enclosed in quotes;</li>
<li>Specifies each Stratum 1 as a URL that starts with <code>http://</code>, and ends with <code>/cvmfs/@fqrn@</code></li>
</ul>
<p>For example:</p>
<div class="highlight"><pre><span></span><code>CVMFS_SERVER_URL=&quot;http://s1.test.eu/cvmfs/@fqrn@;http://s1.test.us/cvmfs/@fqrn@&quot;
</code></pre></div>
<p>The <code>@fqrn@</code> substring is replaced by CernVM-FS with the <em>fully qualified repository name</em>, like <code>software.eessi.io</code>.</p>
<p><code>CVMFS_SERVER_URL</code> should be specified in the <em>domain-specific configuration file</em> in <code>/etc/cvmfs</code> that is
relevant for the CernVM-FS repository we have replicated on our Stratum 1.</p>
<p>For <code>software.eessi.io</code>, we should add the following to <code>/etc/cvmfs/domain.d/eessi.io.local</code>:</p>
<div class="copy highlight"><pre><span></span><code><span class="na">CVMFS_SERVER_URL</span><span class="o">=</span><span class="s">&quot;http://STRATUM1_IP/cvmfs/@fqrn@&quot;</span>
</code></pre></div>
<p>in which "<code>STRATUM1_IP</code>" must be replaced with (you guessed it)
the IP address or hostname of the private Stratum 1 replica server.</p>
<p>To apply the configuration change, run <code>cvmfs_config reload</code>:</p>
<div class="copy highlight"><pre><span></span><code>sudo<span class="w"> </span>cvmfs_config<span class="w"> </span>reload
</code></pre></div>
<h4 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h4>
<p>To verify that the client configuration was changed correctly, use <code>cvmfs_config stat</code>
(which requires that the repository is mounted):</p>
<div class="copy highlight"><pre><span></span><code>ls<span class="w"> </span>/cvmfs/software.eessi.io
cvmfs_config<span class="w"> </span>stat<span class="w"> </span>-v<span class="w"> </span>software.eessi.io
</code></pre></div>
<p>The output line that starts with <code>Connection</code> should mention <code>online</code>, like this:</p>
<div class="highlight"><pre><span></span><code>Connection: http://.../cvmfs/software.eessi.io through proxy DIRECT (online)
</code></pre></div>
<p>The <code>proxy DIRECT</code> indicates that we are not using a proxy server yet in this setup.</p>
<p>You can also use <code>curl</code> to check the connection to the Stratum 1, by letting it print the HTTP header
for the <code>.cvmfspublished</code> file in the root of the repository:</p>
<div class="copy highlight"><pre><span></span><code>curl<span class="w"> </span>--head<span class="w"> </span>http://STRATUM1_IP/cvmfs/software.eessi.io/.cvmfspublished
</code></pre></div>
<p>the first line of the output should be something like:
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
</code></pre></div></p>
<p>If instead you see <code>403 Forbidden</code> then the proxy server is blocking the connection:
<div class="highlight"><pre><span></span><code>HTTP/1.1 403 Forbidden
</code></pre></div></p>
<h3 id="proxy-private-stratum-1">Proxy + private Stratum 1<a class="headerlink" href="#proxy-private-stratum-1" title="Permanent link">&para;</a></h3>
<p>To have a more complete view, let's now also bring the proxy server back in the game.</p>
<h4 id="reconfigure-squid-proxy">Reconfigure Squid proxy<a class="headerlink" href="#reconfigure-squid-proxy" title="Permanent link">&para;</a></h4>
<p>First we need to make a small but important change to the configuration of the Squid proxy,
to ensure that the proxy server is allowed to connect to the private Stratum 1 replica server.</p>
<p>Update the ACL for the Stratum 1 servers in <code>/etc/squid/squid.conf</code> on the proxy server
by adding the IP address of the private Stratum 1:
<div class="copy highlight"><pre><span></span><code><span class="c"># replace STRATUM1_IP with the IP address of the private Stratum 1</span>
<span class="nb">acl</span><span class="w"> </span>stratum_ones<span class="w"> </span>dstdomain<span class="w"> </span>.eessi.science<span class="w"> </span>STRATUM1_IP
</code></pre></div></p>
<p>And then reload for configuration for the Squid proxy service:</p>
<div class="copy highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>squid
</code></pre></div>
<h4 id="client-configuration_1">Client configuration<a class="headerlink" href="#client-configuration_1" title="Permanent link">&para;</a></h4>
<p>We also need to update the client configuration to restore the <code>CVMFS_HTTP_PROXY</code> line
in <code>/etc/cvmfs/default.local</code>, <a href="../proxy/#client-system-configuration">like we did when using the proxy server</a>:</p>
<div class="copy highlight"><pre><span></span><code><span class="c1"># replace PROXY_IP with the IP address of the proxy server</span>
<span class="na">CVMFS_HTTP_PROXY</span><span class="o">=</span><span class="s">&quot;http://PROXY_IP:3128&quot;</span>
</code></pre></div>
<p>Don't forget to reload the CernVM-FS client configuration:</p>
<div class="copy highlight"><pre><span></span><code>sudo<span class="w"> </span>cvmfs_config<span class="w"> </span>reload
</code></pre></div>
<h4 id="testing_1">Testing<a class="headerlink" href="#testing_1" title="Permanent link">&para;</a></h4>
<p>To test whether the setup using both the proxy server and the Stratum 1 replica server works,
we can try accessing the EESSI repository,
for example by <a href="../../eessi/using-eessi/#init">sourcing the initialisation script</a>:</p>
<div class="copy highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>/cvmfs/software.eessi.io/versions/2023.06/init/bash
</code></pre></div>
<p>The output of <code>sudo cvmfs_config stat -v software.eessi.io</code> should include a <code>Connection</code> line that ends with
<code>(online)</code>, like this:</p>
<div class="highlight"><pre><span></span><code>Connection: http://STRATUM1_IP/cvmfs/software.eessi.io through proxy http://PROXY_IP:3128 (online)
</code></pre></div>
<p>You can also use <code>curl</code> to check whether the Stratum 1 can be reached via the proxy server:</p>
<div class="copy highlight"><pre><span></span><code><span class="nv">http_proxy</span><span class="o">=</span>http://PROXY_IP:3128<span class="w"> </span>curl<span class="w"> </span>--head<span class="w"> </span>http://STRATUM1_IP/cvmfs/software.eessi.io/.cvmfspublished
</code></pre></div>
<h2 id="conclusions">Conclusions<a class="headerlink" href="#conclusions" title="Permanent link">&para;</a></h2>
<p>With a private Stratum 1 replica server, we have a more production-ready setup in place for using CernVM-FS.</p>
<p>Using both a proxy server and a Stratum 1 replica server is another step in that direction,
since it further improves the resilience, maintainability, scalability, and performance of the setup
(since the proxy server can serve request from its memory cache).</p>
<p>For the sake of demonstration we have used two separate systems for the Stratum 1 replica server and the
proxy server, but both services can also be installed and configuration on the same server, and
also installing <em>multiple</em> proxy servers is sensible to improve load balancing, for example to serve
different HPC clusters that have significantly different workload mixes.</p>
<hr />
<p><em>(next: <a href="../alternatives/">Alternative ways to access CernVM-FS repositories</a>)</em></p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 1, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["instant"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>